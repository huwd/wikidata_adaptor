#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

# Load integration/.env if present (do not override already-exported vars)
if [[ -f integration/.env ]]; then
	# Parse dotenv-style KEY=VALUE lines without shell-evaluating.
	# This allows values with spaces (e.g. ES_JAVA_OPTS=-Xms512m -Xmx512m ...).
	while IFS= read -r line || [[ -n "$line" ]]; do
		[[ "$line" =~ ^[[:space:]]*# ]] && continue
		[[ "$line" =~ ^[[:space:]]*$ ]] && continue
		if [[ "$line" =~ ^([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
			key="${BASH_REMATCH[1]}"
			val="${BASH_REMATCH[2]}"
			# Don't override already-exported vars
			if [[ -z "${!key+x}" ]]; then
				export "$key=$val"
			fi
		fi
	done < integration/.env
fi

export INTEGRATION=1
export WIKIBASE_PORT="${WIKIBASE_PORT:-8080}"
export WIKIBASE_REST_ENDPOINT="${WIKIBASE_REST_ENDPOINT:-http://localhost:${WIKIBASE_PORT}/w/rest.php/wikibase}"

bundle exec rspec --tag integration
